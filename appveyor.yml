version: '{build}'

image: Visual Studio 2022

environment:
  nodejs_version: '20.19.4'
  EXPO_NO_TELEMETRY: '1'
  CI: 'true'
  CSC_IDENTITY_AUTO_DISCOVERY: 'false'

init:
  - ps: Update-AppveyorBuild -Message "Mulfa Windows NSIS build"

install:
  - ps: |
      # Install Node.js (minimum required for Expo SDK 54 is >= 20.19.4)
      Install-Product node $env:nodejs_version
      $nodeVer = (node -v) -replace 'v',''
      $minVer = [version]'20.19.4'
      try { $currVer = [version]$nodeVer } catch { $currVer = [version]'0.0.0' }
      if ($currVer -lt $minVer) {
        Write-Host "Node version $currVer is below required $minVer; installing via Chocolatey"
        choco install nodejs-lts -y --version=$env:nodejs_version
        refreshenv
      }
      node -v
      npm -v
      # Ensure global npm bin directory exists to prevent ENOENT in npx
      $npmBin = Join-Path $env:APPDATA 'npm'
      if (-not (Test-Path $npmBin)) { New-Item -ItemType Directory -Path $npmBin | Out-Null }
      # System deps
      choco install nsis 7zip -y

build_script:
  - ps: |
      # Move into app directory
      cd app
      # Install npm deps (avoid peer conflicts and lock mismatches for Expo SDK 54)
      npm i --no-audit --legacy-peer-deps
      # Export web assets (optional but aligns with electron-builder files config)
      npm run build:web
      # Build the Windows NSIS installer
      npx electron-builder --win nsis --x64 --publish never --log-level debug
      # List output for debugging
      if (Test-Path 'dist_electron') { Get-ChildItem -Force 'dist_electron' } else { Write-Host 'dist_electron not found' }

artifacts:
  - path: app\dist_electron\Mulfa-Setup-*.exe
    name: Mulfa-Setup
  - path: app\dist_electron\builder-debug.yml
    name: builder-debug
  - path: app\dist_electron\builder-effective-config.yaml
    name: builder-effective-config

skip_branch_with_pr: false
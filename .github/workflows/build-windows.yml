name: Build Windows NSIS installer

on:
  workflow_dispatch:
  push:
    paths:
      - "app/**"
      - ".github/workflows/build-windows.yml"

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install system dependencies (NSIS, 7zip)
        shell: powershell
        run: |
          choco install nsis 7zip -y

      - name: Print tool versions
        shell: powershell
        run: |
          node -v
          npm -v
          npx electron-builder --version

      - name: Install npm dependencies
        working-directory: app
        run: npm ci

      - name: Run CI packaging script (Expo export + electron-builder)
        working-directory: app
        env:
          EXPO_NO_TELEMETRY: '1'
          CI: 'true'
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        run: powershell -ExecutionPolicy Bypass -File scripts/ci.ps1

      - name: List build output directory
        shell: powershell
        run: |
          if (Test-Path 'app/dist_electron_new') { Get-ChildItem -Force 'app/dist_electron_new' } else { Write-Output 'dist_electron_new not found' }

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mulfa-Setup
          path: |
            app/dist_electron_new/Mulfa-Setup-*.exe
            app/dist_electron_new/builder-debug.yml
            app/dist_electron_new/builder-effective-config.yaml
          if-no-files-found: error